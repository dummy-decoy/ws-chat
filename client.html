<!DOCTYPE html>
<html>
    <head>
        <title>chat</title>
        <style type="text/css">
            html, body {
                margin: 0;
                background-color: #aaaaaa;
            }
            #wrapper {
                display: flex;
                flex-direction: column;
                height: 100vh;
                width: 100%;
                overflow-y: hidden;
            }
            #input {
                margin: 8px;
            }
            #content {
                margin: 8px;
                flex-grow: 1;
                overflow-y: scroll;
                overflow-x: auto;
            }

            .error {
                font-weight: bold;
                color: red;
            }
            .info {
                font-weight: normal;
                color: lightslategray;
            }
            .wall {
                font-weight: normal;
                color: red;
            }
            .user {
                font-weight: bold;
                color: green;
            }
            .channel {
                font-weight: bold;
                color: blue;
            }
            .topic {
                font-weight: bold;
                color: black;
            }
        </style>
        <script lang="javascript">
            function sanitize(string) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&apos;',
                    '/': '&sol;',
                    '=': '&equals;',
                    '`': '&grave;'
                };
                const reg = /[&<>"'/=`]/ig;
                return string.replace(reg, (match)=>(map[match]));
            };

            var content = undefined;
            function append(text) {
                content.innerHTML += text+'<br/>';
                content.scrollTop = content.scrollHeight;
            }

            var ws = { send: () => { append('<span class="error">not connected to any server</span>');} };

            function connect(host) {
                ws = new WebSocket(`ws://${host}`);
                ws.onmessage = (event) => {
                    try {
                        //append(event.data);
                        let message = JSON.parse(event.data);
                        switch (message[0]) {
                            case 'version':
                                break;
                            case 'motd':
                                append(`<span class="wall">${sanitize(message[1].content).replace('\n','<br/>')}</span>`);
                                break;
                            case 'time':
                                append(`<span class="wall">the time on the server is ${sanitize(message[1].local)}</span>`);
                                break;
                            case 'nick':
                                if (!('old' in message[1]) || !('channel' in message[1]))
                                    append(`you are now known as <span class="user">@${sanitize(message[1].new)}</span>`);
                                else if ('channel' in message[1])
                                    append(`<span class="channel">#${sanitize(message[1].channel)}</span>: <span class="user">@${sanitize(message[1].old)}</span> changed name to <span class="user">@${sanitize(message[1].new)}</span>`);
                                else
                                    append(`<span class="user">@${sanitize(message[1].old)}</span> changed name to <span class="user">@${sanitize(message[1].new)}</span>`);
                                break;
                            case 'list':
                                if (message[1].channels.length)
                                    append(`<span class="wall">channel list:<br>&emsp;<span class="channel">#${message[1].channels.map(sanitize).join('</span><br>&emsp;<span class="channel">#')}</span>`);
                                else
                                    append('<span class="wall">channel list is empty</span>');
                                break;
                            case 'users':
                                append(`<span class="channel">#${sanitize(message[1].channel)}</span>: user list:<br>&emsp;<span class="user">@${message[1].users.map(sanitize).join('</span><br>&emsp;<span class="user">@')}</span>`);
                                break;
                            case 'join':
                                append(`<span class="channel">#${sanitize(message[1].channel)}</span>: <span class="user">@${sanitize(message[1].user)}</span> joined the channel`);
                                break;
                            case 'topic':
                                if (message[1].value)
                                    append(`<span class="channel">#${sanitize(message[1].channel)}</span>: topic was set to "<span class="topic">${sanitize(message[1].value)}</span>"`);
                                else
                                    append(`<span class="channel">#${sanitize(message[1].channel)}</span>: topic was not set`);
                                break;
                            case 'msg':
                                if ('channel' in message[1])
                                    append(`<span class="channel">#${sanitize(message[1].channel)}</span>: <span class="user">@${sanitize(message[1].from)}</span>: ${sanitize(message[1].content)}`);
                                else
                                    append(`<span class="user">@${sanitize(message[1].from)}</span>: <span class="user">@${sanitize(message[1].user)}</span>: ${sanitize(message[1].content)}`);
                                break;
                            case 'leave':
                                append(`<span class="channel">#${sanitize(message[1].channel)}</span>: <span class="user">@${sanitize(message[1].user)}</span> left the channel (${sanitize(message[1].reason||'no reason')})`);
                                break;
                            case 'error':
                                append(`<span class="error">${sanitize(message[1].message)}</span>`);
                                break;
                        }
                    } catch (error) {
                        console.log('pfiout');
                    }
                };
            };

            function help() {
                append('<span class="info">'
                    + '<p>This is ws-chat (tentative name), an IRC like chat running in your browser.</p>'
                    + '<p>command help:<table>'
                    + '<tr><td style="vertical-align:top">/help</td><td>show this help message</td></tr>'
                    + '<tr><td style="vertical-align:top">/connect&nbsp;&lt;host:port&gt;</td><td>connect to a chat server</td></tr>'
                    + '<tr><td style="vertical-align:top">/motd</td><td>display the server message of the day</td></tr>'
                    + '<tr><td style="vertical-align:top">/time</td><td>show the server local time</td></tr>'
                    + '<tr><td style="vertical-align:top">/nick&nbsp;&lt;nickname&gt;</td><td>set the nickname you will be yelled at</td></tr>'
                    + '<tr><td style="vertical-align:top">/list</td><td>list all channels on this server</td></tr>'
                    + '<tr><td style="vertical-align:top">/users&nbsp;&lt;#channel&gt;</td><td>list all users on the specified channel. you must have joined the channel to see the list</td></tr>'
                    + '<tr><td style="vertical-align:top">/join&nbsp;&lt;#channel&gt;</td><td>join a channel and participate ! if the channel does not exist, it is automatically created.</td></tr>'
                    + '<tr><td style="vertical-align:top">/topic&nbsp;&lt;#channel&gt;</td><td>show the current topic of the specified channel</td></tr>'
                    + '<tr><td style="vertical-align:top">/topic&nbsp;&lt;#channel&gt;&nbsp;&lt;topic...&gt;</td><td>set the topic of the specified channel</td></tr>'
                    + '<tr><td style="vertical-align:top">/msg&nbsp;&lt;#channel&gt;&nbsp;&lt;message...&gt;</td><td>send a message to the specified channel</td></tr>'
                    + '<tr><td style="vertical-align:top">/msg&nbsp;&lt;@user&gt;&nbsp;&lt;message...&gt;</td><td>send a private message to the specified user</td></tr>'
                    + '<tr><td style="vertical-align:top">/leave &lt;#channel&gt;</td><td>leave the channel. the channel is automatically destroyed when the last particiapnt leaves</td></tr>'
                    + '<tr><td style="vertical-align:top">/select &lt;#channel&gt;</td><td>makes the specified channel the active channel. everything you type in the input box will be sent to this channel</td></tr></table>'
                    + '</p>'
                    + '</span>')
            }

            var currentChannel = undefined;
            function input() {
                let error = (text) => {
                    append('<span class="error">'+text+'</span>');
                }
                let info = (text) => {
                    append('<span class="info">'+text+'</span>');
                }
                let split = (input, limit=-1) => {
                    separator = /\s+/g
                    const output = [];
                    let finalIndex = 0;
                    while (limit--) {
                        const lastIndex = separator.lastIndex;
                        const search = separator.exec(input);
                        if (search === null) {
                            break;
                        }
                        finalIndex = separator.lastIndex;
                        output.push(input.slice(lastIndex, search.index));
                    }
                    output.push(input.slice(finalIndex));
                    return output;
                }
                let send = (command, args=undefined) => {
                    data = [command];
                    if (args) data.push(args);
                    ws.send(JSON.stringify(data));
                }

                let input = document.getElementById('message');
                let command = input.value.trimEnd();
                if (command == '/help') {
                    help();
                } else if (command.startsWith('/connect ')) {
                    args = split(command, 2);
                    if (args.length > 2) error('/connect: too many arguments');
                    else connect(args[1]);
                } else if (command == '/motd') {
                    send('motd');
                } else if (command == '/time') {
                    send('time');
                } else if (command.startsWith('/nick ')) {
                    args = split(command, 2);
                    if (args.length > 2) error('/nick: too many arguments');
                    else send('nick',{'new':args[1]});
                } else if (command == '/list') {
                    send('list');
                } else if (command.startsWith('/users ')) {
                    args = split(command, 2);
                    if (args.length > 2) error('/users: too many arguments');
                    else {
                        if (!args[1].startsWith('#')) error('/users: channel expected');
                        else send('users',{'channel':args[1].slice(1)})
                    };
                } else if (command.startsWith('/join ')) {
                    args = split(command, 2);
                    if (args.length > 2) error('/join: too many arguments');
                    else {
                        if (!args[1].startsWith('#')) error('/join: channel expected');
                        else send('join',{'channel':args[1].slice(1)})
                    };
                } else if (command.startsWith('/topic ')) {
                    args = split(command, 2);
                    if (!args[1].startsWith('#')) error('/topic: channel expected');
                    else send('topic',{'channel':args[1].slice(1), 'value': args.length>2?args[2]:undefined})
                } else if (command.startsWith('/msg ')) {
                    args = split(command, 2);
                    if (args.length<3) error('/msg: missing the message...');
                    else {
                        if (args[1].startsWith('#')) send('msg', {'channel':args[1].slice(1), 'content':args[2]});
                        else if (args[1].startsWith('@')) send('msg', {'user':args[1].slice(1), 'content':args[2]});
                        else error('/msg: channel or user expected');
                    }
                } else if (command.startsWith('/leave ')) {
                    args = split(command, 2);
                    if (!args[1].startsWith('#')) error('/leave: channel expected');
                    else send('leave',{'channel':args[1].slice(1), 'reason': args.length>2?args[2]:undefined})
                } else if (command.startsWith('/select ')) {
                    args = split(command, 2);
                    if (args.length > 2) error('/select: too many arguments');
                    else {
                        if (!args[1].startsWith('#')) error('/select: channel expected');
                        else { 
                            currentChannel = args[1].slice(1);
                            info(`<span class="channel">#${sanitize(currentChannel)}</span> is now the active channel`);
                        }
                    };
                } else {
                    if (currentChannel) send('msg', {'channel':currentChannel, 'content':command});
                    else error('no channel selected. use /select to set the active channel.');
                }
                input.value = '';
            };

            window.onload = () => {
                content = document.getElementById('content');
                help();
            }
        </script>
    </head>
    <body bgcolor="#aaaaaa">
        <div id="wrapper">
            <div id="input">
                <form action="javascript:input()">
                    <input type="text" id="message" style="width:80%"/><input type="submit" value="send"/>
                </form>
            </div>
            <div id="content"></div>
        </div>
    </body>
</html>